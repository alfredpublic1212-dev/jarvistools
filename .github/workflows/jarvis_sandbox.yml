name: Jarvis Sandbox CI Policy Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  jarvis-policy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Jarvis Sandbox Policy Check (User Code Only)
        run: |
          python - << 'EOF'
          import sys
          from pathlib import Path
          from services.review_brain import ReviewBrain
          from core.explain_engine import explain_results
          from core.policy_engine import evaluate_policy

          brain = ReviewBrain()

          # IMPORTANT: scan ONLY user code
          target_dir = Path("examples")

          if not target_dir.exists():
              print("No examples/ directory found. Skipping.")
              sys.exit(0)

          py_files = list(target_dir.rglob("*.py"))
          if not py_files:
              print("No Python files found in examples/. Skipping.")
              sys.exit(0)

          all_issues = []

          for file in py_files:
              code = file.read_text()
              issues = brain.review_code({
                  "file": str(file),
                  "language": "python",
                  "code": code,
                  "scope": "ci",
              })
              explained = explain_results(issues)
              all_issues.extend(explained)

          policy = evaluate_policy(
              all_issues,
              warning_threshold=5
          )

          print("Policy result:")
          print(policy)

          if policy["status"] == "fail":
              sys.exit(1)

          print("Jarvis Sandbox policy passed.")
          EOF
