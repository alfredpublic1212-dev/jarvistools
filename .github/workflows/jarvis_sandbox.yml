name: Jarvis Sandbox CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  jarvis-review:
    runs-on: ubuntu-latest

    steps:
      # 1️ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️ Python setup
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3️ Install dependencies
      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # 4️ Start Jarvis Sandbox (LOCAL to CI machine)
      - name: Start Jarvis Sandbox
        run: |
          uvicorn services.jarvis_service:app --host 0.0.0.0 --port 8000 &
          echo "Waiting for Jarvis Sandbox to start..."
          for i in {1..20}; do
            if curl -s http://localhost:8000/health > /dev/null; then
              echo "Jarvis Sandbox is ready!"
              break
            fi
            sleep 1
          done

      # 5️Run policy enforcement
      - name: Run Jarvis Sandbox Policy Check
        run: |
          python - << 'EOF'
          import requests
          import json
          import sys
          from pathlib import Path

          py_files = list(Path(".").rglob("*.py"))
          if not py_files:
              print("No Python files found. Skipping.")
              sys.exit(0)

          code = py_files[0].read_text()

          payload = {
              "file": str(py_files[0]),
              "language": "python",
              "code": code,
              "scope": "ci",
              "policy": {
                  "warning_threshold": 5
              }
          }

          response = requests.post(
              "http://localhost:8000/review",
              json=payload,
              timeout=30
          )

          data = response.json()

          policy = data.get("policy")
          if policy and policy["status"] == "fail":
              print("Jarvis Sandbox policy failed:")
              print(json.dumps(policy, indent=2))
              sys.exit(1)

          print("Jarvis Sandbox policy passed")
          EOF
